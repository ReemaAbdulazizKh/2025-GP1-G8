<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Brainalyze | Patients</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&family=Cairo:wght@300;400;600&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/patients.css') }}">
</head>

<body>

<div class="sidebar-overlay" id="sidebarOverlay"></div>

<aside class="sidebar">
  <div class="brand" onclick="window.location.href='{{ url_for('home') }}'">
    <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Brainalyze">
    <span>Brainalyze</span>
  </div>

  <nav class="nav">
    <a href="{{ url_for('home') }}">
      <img src="{{ url_for('static', filename='images/home-icon.jpg') }}" alt=""><span>Home</span>
    </a>
    <a class="active" href="{{ url_for('patients') }}">
      <img src="{{ url_for('static', filename='images/patient-icon.png') }}" alt=""><span>Patients</span>
    </a>
    <a href="{{ url_for('profile') }}">
      <img src="{{ url_for('static', filename='images/user-icon.jpg') }}" alt=""><span>Profile</span>
    </a>
  </nav>

  <div class="sidebar-footer">
    <a href="#" id="logoutBtn" class="logout">
      <span>Logout</span>
    </a>
  </div>
</aside>

<div class="popup-overlay" id="logoutPopup">
  <div class="popup-box">
    <h2>Confirm Logout</h2>
    <p>Are you sure you want to log out?</p>
    <div class="popup-buttons">
      <button class="popup-cancel" id="cancelLogout">Cancel</button>
      <button class="popup-confirm" id="confirmLogout">Yes, Logout</button>
    </div>
  </div>
</div>

<div class="main-wrapper">

  <div id="docheader">
    <div style="display:flex; align-items:center; gap:15px;">
      <button class="toggle-btn" id="toggleBtn">
        <img src="{{ url_for('static', filename='images/sidebar_icon.png') }}"
             alt="menu" width="32" height="32" style="object-fit: contain;">
      </button>
      <span id="pageTitle">Patients</span>
    </div>

    <div class="doctor-info">
      <div class="doctor-details">
        <h2>Dr. {{ doctor.name }}</h2>
        <p>{{ doctor.email }}</p>
      </div>
      <img
        src="{{ doctor.ProfilePicture if doctor.ProfilePicture else url_for('static', filename='images/user.png') }}"
        class="profile-pic" alt="Profile"
        onclick="window.location.href='{{ url_for('profile') }}'">
    </div>
  </div>

  <div class="main" id="main">

    <section class="glass-card">
      <div>
        <h1 class="page-title">Patients</h1>
        <p class="page-subtitle">Manage your patients, view their cases, and add new scans.</p>
      </div>

      <div class="actions-row">
        <form method="get" class="search-container" action="{{ url_for('patients') }}">
          <input
            class="search-input"
            type="text"
            name="q"
            placeholder="Search by name or ID..."
            value="{{ q or '' }}">
        </form>

        <button class="btn-add" id="addBtn">
          + Add New Patient
        </button>
      </div>
    </section>

    <section class="glass-card">
      {% if patients %}
        <div class="patients-list">
          {% for p in patients %}
          <div class="patient-card">
            <div class="patient-info">
              <div class="patient-avatar">{{ p.Initials }}</div>
              <div class="patient-details">
                <h4>{{ p.FullName }}</h4>
                <p>{{ p.Age }} years, {{ p.Gender }}</p>
                <p>Condition: {{ p.TumorType or 'N/A' }}</p>
                <p>Last Visit: {{ p.LastMRIDate or '—' }}</p>
              </div>
            </div>
            <div class="patient-actions">
              <a class="view-btn" href="{{ url_for('patient_profile', patient_id=p.id) }}">
                View Profile
              </a>
              <form action="{{ url_for('delete_patient', patient_id=p.id) }}" method="POST"
                    onsubmit="return confirm('Are you sure you want to delete this patient and all related data?');"
                    style="margin-top:8px;">
                <button type="submit" class="delete-btn">Delete</button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p style="text-align:center;color:#666;margin:10px 0;">No patients found.</p>
      {% endif %}
    </section>

  </div>

  <footer class="footer-medical">
    <div class="fm-wrapper">
      <div class="fm-left">
        <img src="/static/images/logo.png" class="fm-logo" alt="Brainalyze">
        <span class="fm-copy">© 2025 Brainalyze</span>
      </div>

      <div class="fm-center">
        <span class="fm-title">FOLLOW US</span>
        <div class="fm-icons">
          <a style="text-decoration: none; color: black;" href="https://x.com/brainalyze_co">
            <img src="/static/images/twitter.png" alt=""><br> @brainalyze_co
          </a>
        </div>
      </div>

      <div class="fm-right">
        <span class="fm-title">CONTACT</span>
        <p class="fm-contact">+966530782404</p>
        <p class="fm-contact">443200466@student.ksu.edu.sa</p>
      </div>
    </div>
  </footer>
</div>

<div id="addModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeAdd()">&times;</span>
    <h3>Add New Patient</h3>

    <form action="{{ url_for('patients') }}" method="POST" enctype="application/x-www-form-urlencoded">

      <input
        type="text"
        name="FullName"
        placeholder="Full Name"
        required
        maxlength="50"
        pattern="^[A-Za-zÀ-ÖØ-öø-ÿ\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\s'.-]{3,50}$">

      <input type="number" name="Age" placeholder="Age" required min="0" max="120" step="1">

      <div class="phone-input">
        <span class="flag">
          <img src="{{ url_for('static', filename='images/saudi-flag.png') }}" alt="SA Flag" class="flag-img">
          +966
        </span>
        <input type="tel" name="ContactNumber"
               placeholder="5XXXXXXXX"
               required pattern="^5\d{8}$" maxlength="9">
      </div>

      <select name="Gender" required style="margin-top:12px;">
        <option value="">Select Gender</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
      </select>

      <textarea name="MedicalNotes" placeholder="Medical notes (optional)" rows="4"></textarea>

      <button type="submit" class="btn-add" style="width:100%; margin-top:8px;">
        Add Patient
      </button>

    </form>
  </div>
</div>

<div id="filterModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeFilter()">&times;</span>
    <h3>Filter Patients</h3>

    <form method="get" action="{{ url_for('patients') }}">
      <label style="font-size:13px;color:#6b7280;">Tumor Type:</label>
      <select name="tumor">
        <option value="">All</option>
        {% for t in tumor_types %}
          <option value="{{ t }}" {% if tumor == t %}selected{% endif %}>{{ t }}</option>
        {% endfor %}
      </select>

      <label style="font-size:13px;color:#6b7280;">From Date:</label>
      <input type="date" name="from" value="{{ date_from or '' }}">

      <label style="font-size:13px;color:#6b7280;">To Date:</label>
      <input type="date" name="to" value="{{ date_to or '' }}">

      {% if q %}<input type="hidden" name="q" value="{{ q }}">{% endif %}

      <button type="submit" class="btn-add" style="width:100%; margin-top:8px;">
        Apply Filter
      </button>

    </form>
  </div>
</div>

<script>
const filterModal = document.getElementById("filterModal");
const addModal    = document.getElementById("addModal");
const filterBtn   = document.getElementById("filterBtn");
const addBtn      = document.getElementById("addBtn");

if (filterBtn && filterModal) {
  filterBtn.onclick = () => filterModal.style.display = "flex";
}

if (addBtn && addModal) {
  addBtn.onclick = () => addModal.style.display = "flex";
}

function closeFilter(){
  if (filterModal) filterModal.style.display = "none";
}
function closeAdd(){
  if (addModal) addModal.style.display = "none";
}

window.addEventListener("click", (e) => {
  if (filterModal && e.target === filterModal) {
    filterModal.style.display = "none";
  }
  if (addModal && e.target === addModal) {
    addModal.style.display = "none";
  }
});
</script>

<script>
const pageTitle = document.getElementById("pageTitle");
const toggleBtn = document.getElementById("toggleBtn");
const sidebar   = document.querySelector(".sidebar");
const docheader = document.getElementById("docheader");
const main      = document.getElementById("main");
const overlay   = document.getElementById("sidebarOverlay");

toggleBtn.addEventListener("click", () => {
  if (window.innerWidth > 768) {
    sidebar.classList.toggle("collapsed");
  } else {
    sidebar.classList.toggle("active");
    overlay.classList.toggle("active");
  }
});

overlay.addEventListener("click", () => {
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
});

pageTitle.textContent = "Patients";

function isMobile() {
  return window.innerWidth <= 768;
}

overlay.addEventListener("click", () => {
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
});

const logoutBtn     = document.getElementById("logoutBtn");
const logoutPopup   = document.getElementById("logoutPopup");
const confirmLogout = document.getElementById("confirmLogout");
const cancelLogout  = document.getElementById("cancelLogout");

logoutBtn.addEventListener("click", function (event) {
  event.preventDefault();
  logoutPopup.style.display = "flex";
});

cancelLogout.addEventListener("click", function () {
  logoutPopup.style.display = "none";
});

confirmLogout.addEventListener("click", function () {
  logoutPopup.style.display = "none";
  sessionStorage.clear();
  localStorage.clear();
  window.location.href = "{{ url_for('logout') }}";
});

window.addEventListener("click", function (event) {
  if (event.target === logoutPopup) {
    logoutPopup.style.display = "none";
  }
});
</script>

<script>
function showToast(msg, color) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.style.background = color;
  t.style.opacity = "1";
  t.style.transform = "translateY(0)";
  setTimeout(() => {
    t.style.opacity = "0";
    t.style.transform = "translateY(20px)";
  }, 2500);
}
</script>

{% set flashed = get_flashed_messages(with_categories=True) %}
<script>
const flashedMessages = {{ flashed|tojson }};
window.addEventListener("DOMContentLoaded", () => {
  flashedMessages.forEach(([category, message]) => {
    if (message === "Profile updated successfully") return;
    if (category === "success") showToast(message, "#10b981");
    if (category === "danger") showToast(message, "#ef4444");
  });
});
</script>

<div id="toast"
     style="
        position: fixed;
        top: 20px;
        margin-left: 50%;
        margin-right: 50%;
        width:max-content;
        transform: translateX(-50%);
        padding: 9px 20px;
        background: #10b981ac;
        color: #fff;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 500;
        box-shadow: 0 8px 18px rgba(0,0,0,0.15);
        z-index: 999999;
        opacity: 0;
        pointer-events: none;
        transition: opacity .35s ease, transform .35s ease;
        border: #10b981 1.5px solid;
     ">
</div>

</body>
</html>
